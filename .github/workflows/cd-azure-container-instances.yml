name: CD - Deploy to Azure Container Instances

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_RESOURCE_GROUP: influencer-api-rg
  CONTAINER_NAME: influencer-api
  REGISTRY_NAME: ${{ secrets.AZURE_ACR_NAME }}

jobs:
  build-and-deploy:
    name: Build and Deploy to ACI
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Extract tag name
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "Tag name: $TAG_NAME"
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Note about image push
        run: |
          echo "âš ï¸  Image push is disabled. Please push the image manually to ACR:"
          echo "   ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }}"
          echo ""
          echo "To push manually:"
          echo "   docker tag influencer-api:${{ steps.tag.outputs.tag }} ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }}"
          echo "   az acr login --name ${{ env.REGISTRY_NAME }}"
          echo "   docker push ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }}"

      - name: Create or update Azure Container Instance
        run: |
          # Check if container instance exists
          if az container show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} &>/dev/null; then
            echo "Updating existing container instance..."
            az container create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.CONTAINER_NAME }} \
              --image ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }} \
              --registry-login-server ${{ env.REGISTRY_NAME }}.azurecr.io \
              --registry-username ${{ secrets.AZURE_ACR_USERNAME }} \
              --registry-password ${{ secrets.AZURE_ACR_PASSWORD }} \
              --dns-name-label ${{ env.CONTAINER_NAME }}-${{ github.run_number }} \
              --ports 8000 \
              --cpu 2 \
              --memory 4 \
              --environment-variables \
                AZURE_COSMOS_ENDPOINT="${{ secrets.AZURE_COSMOS_ENDPOINT }}" \
                AZURE_COSMOS_KEY="${{ secrets.AZURE_COSMOS_KEY }}" \
                AZURE_COSMOS_DATABASE="${{ secrets.AZURE_COSMOS_DATABASE }}" \
                AZURE_COSMOS_CONTAINER="${{ secrets.AZURE_COSMOS_CONTAINER }}" \
                AZURE_SEARCH_ENDPOINT="${{ secrets.AZURE_SEARCH_ENDPOINT }}" \
                AZURE_SEARCH_KEY="${{ secrets.AZURE_SEARCH_KEY }}" \
                AZURE_SEARCH_INDEX_NAME="${{ secrets.AZURE_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
                AZURE_OPENAI_DEPLOYMENT_NAME="${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}" \
                AZURE_OPENAI_CHAT_DEPLOYMENT="${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}" \
                ENVIRONMENT=production \
                DEBUG=false \
              --restart-policy Always \
              --overwrite
          else
            echo "Creating new container instance..."
            az container create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.CONTAINER_NAME }} \
              --image ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }} \
              --registry-login-server ${{ env.REGISTRY_NAME }}.azurecr.io \
              --registry-username ${{ secrets.AZURE_ACR_USERNAME }} \
              --registry-password ${{ secrets.AZURE_ACR_PASSWORD }} \
              --dns-name-label ${{ env.CONTAINER_NAME }}-${{ github.run_number }} \
              --ports 8000 \
              --cpu 2 \
              --memory 4 \
              --environment-variables \
                AZURE_COSMOS_ENDPOINT="${{ secrets.AZURE_COSMOS_ENDPOINT }}" \
                AZURE_COSMOS_KEY="${{ secrets.AZURE_COSMOS_KEY }}" \
                AZURE_COSMOS_DATABASE="${{ secrets.AZURE_COSMOS_DATABASE }}" \
                AZURE_COSMOS_CONTAINER="${{ secrets.AZURE_COSMOS_CONTAINER }}" \
                AZURE_SEARCH_ENDPOINT="${{ secrets.AZURE_SEARCH_ENDPOINT }}" \
                AZURE_SEARCH_KEY="${{ secrets.AZURE_SEARCH_KEY }}" \
                AZURE_SEARCH_INDEX_NAME="${{ secrets.AZURE_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
                AZURE_OPENAI_DEPLOYMENT_NAME="${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}" \
                AZURE_OPENAI_CHAT_DEPLOYMENT="${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}" \
                ENVIRONMENT=production \
                DEBUG=false \
              --restart-policy Always
          fi

      - name: Get container instance FQDN
        id: get-fqdn
        run: |
          FQDN=$(az container show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --query ipAddress.fqdn -o tsv)
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          echo "Container is available at: http://$FQDN:8000"

      - name: Health check
        run: |
          sleep 30
          FQDN=$(az container show \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_NAME }} \
            --query ipAddress.fqdn -o tsv)
          curl -f http://$FQDN:8000/health || exit 1

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Container Instance:** ${{ env.CONTAINER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY_NAME }}.azurecr.io/influencer-api:${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**FQDN:** http://${{ steps.get-fqdn.outputs.fqdn }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
